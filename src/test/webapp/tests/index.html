<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Heimklang Test Interface</title>

<style>
    body { font-family: sans-serif; padding: 20px; }
    #devices, #controls, #events { margin-bottom: 20px; }
    .device { cursor: pointer; margin: 5px 0; text-decoration: underline;color:#0066cc;}
    #eventOutput { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; }
    button { margin: 2px; }
</style>
</head>
<body>

<h1>Heimklang Test Interface</h1>

<div id="devices">
    <h2>Devices</h2>
    <button onclick="loadDevices()">Refresh Devices</button>
    <ul id="deviceList"></ul>
</div>

<div id="services">
    <h2>Services</h2>
    <ul id="serviceList">
		<li>Select device to see services</li>
	</ul>
</div>


<div id="events">
    <h2>Events</h2>
    <div id="eventOutput"></div>
</div>

<div>
    <h2>Command</h2>
	<div onclick="sendAction()"><button>callAction</button></div>
	<div>
    	<textarea id="commandArea" rows="10" style="width: 100%;"></textarea>
	</div>
</div>

<script type="module">
import { apiFetch, setBaseUrl, createRendererEventSubcription } from '../js/restupnp.js';

setBaseUrl('../rest');

let currentEventSource = null;
let currentUdn = null;

function loadDevices() {
    apiFetch('../rest/devices/')
        .then((apiResult) => {
            const list = document.getElementById('deviceList');
            list.innerHTML = '';
			apiResult.data.devices.forEach(device => {
                const li = document.createElement('li');
                li.className = 'device';
                li.textContent = device.friendlyName + ' (' + device.udn + ')';
                li.onclick = () => selectDevice(device.udn, device.type);
                list.appendChild(li);
            });
        })
        .catch(errInfo => alert('Error loading devices: ' + errInfo.summary));
}

function selectDevice(udn, deviceType) {
    currentUdn = udn;
	loadServices();
    subscribeToEvents(udn, deviceType);
}

function containsOutputArgument(actionArguments) {
	return actionArguments.some(action => {
		return action.direction == 'OUT';
	});		
}

function loadServices() {
    apiFetch('../rest/devices/'+ encodeURIComponent(currentUdn), { method: 'GET' })
        .then(apiResult => {
            const list = document.getElementById('serviceList');
            list.innerHTML = '';
            apiResult.data.services.forEach(service => {                
				
				if (service.type.includes('schemas-upnp-org:')) {
				
					const serviceLi = document.createElement('li');
	                serviceLi.className = 'service';
					serviceLi.appendChild(document.createElement('div')).textContent = service.id + ' (' + service.type + ')';
					
					let isContentServer = service.type.includes('schemas-upnp-org:ContentDirectory'),
						isRenderControl = service.type.includes('schemas-upnp-org:RenderingControl'),
						isTransport = service.type.includes('schemas-upnp-org:AVTransport');
				
					const actionDiv = serviceLi.appendChild(document.createElement('div'));
					const actionList = actionDiv.appendChild(document.createElement('ul'));
					
					service.actions.forEach(action => {
						const actionLi = actionList.appendChild(document.createElement('li'));
						actionLi.className = 'action';
						
						if (!containsOutputArgument(action.arguments)) {
							const btn = actionLi.appendChild(document.createElement('button'));
							btn.textContent = action.name;
							btn.onclick = () => prepareCommand(service, action);
						} else {
							actionLi.appendChild(document.createElement('span')).textContent = action.name;							
						}
						
						actionLi.appendChild(document.createElement('span')).textContent = ' : ';
						actionLi.appendChild(document.createElement('i')).textContent = JSON.stringify(action.arguments);
					});
									
	                list.appendChild(serviceLi);
				}
            });
        })
        .catch(errInfo => alert('Error loading services: ' + errInfo.summary));
}



function subscribeToEvents(udn, deviceType) {
    if (currentEventSource) {
        currentEventSource.close();
        document.getElementById('eventOutput').innerHTML = '';
    }

	if (deviceType == 'MediaRenderer') {
		
	    currentEventSource = createRendererEventSubcription(udn, '0', (event) => {
			console.log(event);
			eventOutput.textContent += event.type + ':"' + event.data + '"\n';
			eventOutput.scrollTop = eventOutput.scrollHeight;
		});
	
	    currentEventSource.onerror = (err) => {
	        console.error('EventSource error:', err);
	        currentEventSource.close();
	    };		
	}
}

function prepareCommand(service, action) {
	let inputArguments = [];
	
	inputArguments.push({});
		
	let data = {
		'serviceId': service.id,
		'action': action.name,
		'inputArguments' : Object.fromEntries(action.arguments.map((arg) => {
			if (arg.name == 'InstanceID') {
				return [arg.name, '0'];
			} else if (arg.name == 'Channel') {
				return [arg.name, 'Master'];				
			} else if (arg.datatype.startsWith('ui')) {
				return [arg.name, '100'];
			} else {
				return [arg.name, ' '];
			}
		}))
	};
	
	commandArea.value = JSON.stringify(data, undefined, 3);
}

window.sendAction = () => {
    const url = '../rest/devices/' + encodeURIComponent(currentUdn) + '/callAction';
	apiFetch(url, {
	  method: "POST",
	  body: commandArea.value,
	  headers: {
	    "Content-type": "application/json; charset=UTF-8"
	  }
	}).then(({response, data}) => {
		alert(response.status + ' ' + response.statusText);
		console.log(data);
    }).catch((errInfo) => {
		console.log(errInfo);
		alert('Action failed: ' + errInfo.summary);
	});
}

// auto-load devices on page load
loadDevices();
</script>

</body>
</html>